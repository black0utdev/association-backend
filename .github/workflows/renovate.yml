name: Renovate

on:
  # Run on-demand
  workflow_dispatch:
    inputs:
      logLevel:
        description: "Log level"
        required: false
        default: "debug"
        type: choice
        options:
          - debug
          - info
          - warn
          - error

  # Run on schedule (every Monday at 6am UTC)
  schedule:
    - cron: "0 6 * * 1"

  # Run when renovate config is updated
  push:
    branches:
      - main
    paths:
      - "renovate.json"
      - ".github/renovate.json5"
      - ".github/workflows/renovate.yml"

env:
  LOG_LEVEL: ${{ inputs.logLevel || 'info' }}

jobs:
  renovate:
    name: Renovate Dependencies
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get token
        id: get-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.RENOVATE_APP_ID }}
          private-key: ${{ secrets.RENOVATE_APP_PRIVATE_KEY }}
        # Alternative: Use GITHUB_TOKEN for simpler setup
        # Continue on error if secrets are not set
        continue-on-error: true

      - name: Run Renovate
        uses: renovatebot/github-action@v40.1.11
        with:
          configurationFile: renovate.json
          token: ${{ steps.get-token.outputs.token || secrets.GITHUB_TOKEN }}
        env:
          LOG_LEVEL: ${{ env.LOG_LEVEL }}
          RENOVATE_REPOSITORIES: ${{ github.repository }}
          # Platform
          RENOVATE_PLATFORM: github
          RENOVATE_ENDPOINT: https://api.github.com

          # Repository
          RENOVATE_AUTODISCOVER: false

          # Git settings
          RENOVATE_GIT_AUTHOR: "Renovate Bot <bot@renovateapp.com>"

          # PR settings
          RENOVATE_PR_FOOTER: |
            This PR was generated by [Renovate](https://github.com/renovatebot/renovate).

            ---

            **Instructions for reviewers:**
            1. Review the changelog and release notes
            2. Check CI test results
            3. Verify compatibility with current codebase
            4. Test locally if needed: `docker-compose build && docker-compose up -d`
            5. Approve and merge if all checks pass

          # Onboarding
          RENOVATE_ONBOARDING: true
          RENOVATE_ONBOARDING_CONFIG_FILE_NAME: renovate.json
          RENOVATE_REQUIRE_CONFIG: optional
